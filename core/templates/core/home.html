{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "Home" %}{% endblock %}

{% block content %}
<div class="p-3 p-md-4 bg-light rounded">
  <h1 class="mb-2">{% trans "Welcome" %}</h1>
  <p class="mb-3">{% trans "Browse products or view your cart." %}</p>

  <div class="d-flex flex-column flex-md-row gap-2">
    <a class="btn btn-primary" href="{% url 'product_list' %}">{% trans "Go to Products" %}</a>
    <a class="btn btn-outline-secondary" href="{% url 'cart_detail' %}">{% trans "View Cart" %}</a>
  </div>
</div>

<hr class="my-4">

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
  <h3 class="m-0">{% trans "Latest Products" %}</h3>
  <a class="btn btn-sm btn-outline-dark" href="{% url 'product_list' %}">{% trans "See all" %}</a>
</div>

<div class="row">
  {% for p in latest %}
    <div class="col-6 col-md-3 mb-4">
      <div class="card h-100 shadow-sm">
        {% if p.image %}
          <img src="{{ p.image.url }}" class="card-img-top" alt="{{ p.name }}" style="height: 200px; object-fit: cover;">
        {% else %}
          <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
            <span class="text-muted">{% trans "No Image" %}</span>
          </div>
        {% endif %}
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ p.name }}</h5>
          <p class="fw-bold mb-3">${{ p.price }}</p>
          <form method="post" action="{% url 'cart_add' p.id %}" class="mt-auto cart-add-form" data-product-id="{{ p.id }}">
            {% csrf_token %}
            <div class="d-flex gap-2 align-items-center">
              <input type="number" name="quantity" value="1" min="1" max="{{ p.stock }}" class="form-control form-control-sm" style="width: 80px;" {% if p.stock == 0 %}disabled{% endif %}>
              <button type="submit" class="btn btn-success btn-sm flex-fill" {% if p.stock == 0 %}disabled{% endif %}>
                {% if p.stock == 0 %}{% trans "Sold Out" %}{% else %}{% trans "Add" %}{% endif %}
              </button>
            </div>
            <span class="cart-add-message" style="font-size: 0.75rem; display: block; margin-top: 0.25rem;"></span>
          </form>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="col-12">
      <div class="alert alert-warning">
        {% trans "No products yet. Add some from Admin." %}
      </div>
    </div>
  {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const forms = document.querySelectorAll('.cart-add-form');
  
  forms.forEach(function(form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      const button = form.querySelector('button[type="submit"]');
      const messageSpan = form.querySelector('.cart-add-message');
      const originalText = button.textContent.trim();

      // Disable button and show loading
      button.disabled = true;
      button.textContent = '{% trans "Adding..." %}';
      messageSpan.textContent = '';
      messageSpan.className = 'cart-add-message';

      const formData = new FormData(form);
      const url = form.getAttribute('action');

      fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            button.textContent = '{% trans "Added" %}';
            button.classList.remove('btn-success');
            button.classList.add('btn-secondary');
            button.disabled = false;
            messageSpan.textContent = data.message;
            messageSpan.className = 'cart-add-message text-success';

            // Update cart count in navbar
            updateCartCount(data.cart_count);
          } else {
            button.textContent = originalText;
            messageSpan.textContent = data.message;
            messageSpan.className = 'cart-add-message text-danger';
            button.disabled = false;
          }
        })
        .catch(error => {
          console.error('Error:', error);
          button.textContent = originalText;
          button.disabled = false;
          messageSpan.textContent = '{% trans "An error occurred. Please try again." %}';
          messageSpan.className = 'cart-add-message text-danger';
        });
    });
  });

  function updateCartCount(count) {
    const cartBadge = document.querySelector('.badge.bg-danger');
    const cartLink = document.querySelector('a[href*="cart"]');

    if (count > 0) {
      if (cartBadge) {
        cartBadge.textContent = count;
        cartBadge.style.display = '';
      } else if (cartLink) {
        // Create badge if it doesn't exist
        const badge = document.createElement('span');
        badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-circle bg-danger';
        badge.style.cssText = 'font-size: 0.7em; min-width: 1.2em; height: 1.2em; padding: 0.15em 0.3em; line-height: 1; margin-left: -0.5rem;';
        badge.textContent = count;
        cartLink.appendChild(badge);
      }
    } else {
      if (cartBadge) {
        cartBadge.style.display = 'none';
      }
    }
  }
});
</script>
{% endblock %}
