{% extends "base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<div
  class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4 gap-2">
  <h1 class="m-0">Products</h1>
  {% if perms.products.add_product %}
  <a class="btn btn-primary" href="{% url 'product_create' %}">+ Add Product</a>
  {% endif %}
</div>

{% if mine == "1" %}
<div class="alert alert-info">
  <strong>My Products:</strong> Showing only products you own. <a href="{% url 'product_list' %}"
    class="alert-link">View all products</a>
</div>
{% endif %}

<form id="filters-form" method="get" class="row g-2 mb-4">
  {% if mine == "1" %}
  <input type="hidden" name="mine" value="1">
  {% endif %}
  <div class="col-12 col-md-5">
    <input class="form-control" type="text" name="q" id="search-input" placeholder="Search..." value="{{ q }}">
  </div>

  <div class="col-12 col-md-3">
    <select class="form-select" name="category" id="category-select">
      <option value="">All Categories</option>
      {% for c in categories %}
        {% with cid=c.id|stringformat:"s" %}
          <option value="{{ c.id }}" {% if category_id|stringformat:"s" == cid %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endwith %}
      {% endfor %}
    </select>
  </div>

  <div class="col-12 col-md-2">
    <select class="form-select" name="sort" id="sort-select">
      <option value="newest" {% if sort == "newest" %}selected{% endif %}>Newest</option>
      <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>Price ↑</option>
      <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Price ↓</option>
    </select>
  </div>

  <div class="col-12 col-md-2 d-grid">
    <button class="btn btn-secondary" type="button" id="clear-filters">Clear</button>
  </div>
</form>

<div id="product-grid-container">
  {% include "products/_product_grid.html" %}
</div>
<div id="pagination-container">
  {% include "products/_pagination.html" %}
</div>

<script>
  (function () {
    const form = document.getElementById("filters-form");
    const categorySelect = document.getElementById("category-select");
    const sortSelect = document.getElementById("sort-select");
    const searchInput = document.getElementById("search-input");
    const clearBtn = document.getElementById("clear-filters");
    const productGridContainer = document.getElementById("product-grid-container");
    const paginationContainer = document.getElementById("pagination-container");

    // Function to fetch products via API
    function fetchProducts() {
      const params = new URLSearchParams();
      const q = searchInput ? searchInput.value.trim() : "";
      const category = categorySelect ? categorySelect.value : "";
      const sort = sortSelect ? sortSelect.value : "newest";
      const mine = "{{ mine|default:'' }}";

      if (q) params.set("q", q);
      if (category) params.set("category", category);
      if (sort) params.set("sort", sort);
      if (mine === "1") params.set("mine", "1");

      const apiUrl = "{% url 'product_list_api' %}?" + params.toString();

      fetch(apiUrl, {
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      })
        .then(response => response.json())
        .then(data => {
          if (productGridContainer) productGridContainer.innerHTML = data.html;
          if (paginationContainer) paginationContainer.innerHTML = data.pagination;
          
          // Re-initialize cart add forms after updating HTML
          initializeCartForms();
          
          // Update URL without page reload
          const newUrl = window.location.pathname + (params.toString() ? "?" + params.toString() : "");
          window.history.pushState({}, "", newUrl);
        })
        .catch(error => {
          console.error("Error fetching products:", error);
        });
    }

    // Use global debouncer from base.html
    const debouncedFetchProducts = window.createDebouncer ? 
      window.createDebouncer(fetchProducts, 400) : fetchProducts;

    if (categorySelect) {
      categorySelect.addEventListener("change", function () {
        fetchProducts();
      });
    }

    if (sortSelect) {
      sortSelect.addEventListener("change", function () {
        fetchProducts();
      });
    }

    if (searchInput) {
      // Search-as-you-type with debouncer (no Enter required)
      searchInput.addEventListener("input", debouncedFetchProducts);
      
      // Keep Enter key for form submission as fallback
      searchInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          fetchProducts();
        }
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", function () {
        if (searchInput) searchInput.value = "";
        if (categorySelect) categorySelect.value = "";
        if (sortSelect) sortSelect.value = "newest";
        
        fetchProducts();
      });
    }

    // Initialize cart forms (called after dynamic content updates)
    function initializeCartForms() {
      const forms = document.querySelectorAll('.cart-add-form');
      
      forms.forEach(function(form) {
        form.addEventListener('submit', function (e) {
          e.preventDefault();

          const button = form.querySelector('button[type="submit"]');
          const messageSpan = form.querySelector('.cart-add-message');
          const originalText = button.textContent.trim();

          // Disable button and show loading
          button.disabled = true;
          button.textContent = 'Adding...';
          messageSpan.textContent = '';
          messageSpan.className = 'cart-add-message';

          const formData = new FormData(form);
          const url = form.getAttribute('action');

        fetch(url, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              button.textContent = 'Added';
              button.classList.remove('btn-success');
              button.classList.add('btn-secondary');
              button.disabled = false;
              messageSpan.textContent = data.message;
              messageSpan.className = 'cart-add-message text-success';

              // Update cart count in navbar
              updateCartCount(data.cart_count);
            } else {
              button.textContent = originalText;
              messageSpan.textContent = data.message;
              messageSpan.className = 'cart-add-message text-danger';
              button.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            button.textContent = originalText;
            button.disabled = false;
            messageSpan.textContent = 'An error occurred. Please try again.';
            messageSpan.className = 'cart-add-message text-danger';
          });
        });
      });
    }

    function updateCartCount(count) {
      const cartBadge = document.querySelector('.badge.bg-danger');
      const cartLink = document.querySelector('a[href*="cart"]');

      if (count > 0) {
        if (cartBadge) {
          cartBadge.textContent = count;
          cartBadge.style.display = '';
        } else if (cartLink) {
          // Create badge if it doesn't exist
          const badge = document.createElement('span');
          badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-circle bg-danger';
          badge.style.cssText = 'font-size: 0.7em; min-width: 1.2em; height: 1.2em; padding: 0.15em 0.3em; line-height: 1; margin-left: -0.5rem;';
          badge.textContent = count;
          cartLink.appendChild(badge);
        }
      } else {
        if (cartBadge) {
          cartBadge.style.display = 'none';
        }
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
      initializeCartForms();
    });
  })();
</script>
{% endblock %}
