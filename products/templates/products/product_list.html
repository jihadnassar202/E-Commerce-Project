{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "Products" %}{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4 gap-2">
  <h1 class="m-0">{% trans "Products" %}</h1>
  {% if perms.products.add_product %}
    <a class="btn btn-primary" href="{% url 'product_create' %}">+ {% trans "Add Product" %}</a>
  {% endif %}
</div>

{% if mine == "1" %}
  <div class="alert alert-info">
    <strong>{% trans "My Products:" %}</strong>
    {% trans "Showing only products you own." %}
    <a href="{% url 'product_list' %}" class="alert-link">{% trans "View all products" %}</a>
  </div>
{% endif %}

<form id="filters-form" method="get" class="row g-2 mb-4">
  {% if mine == "1" %}
    <input type="hidden" name="mine" value="1">
  {% endif %}

  <div class="col-12 col-md-5">
    <input
      class="form-control"
      type="text"
      name="q"
      id="search-input"
      placeholder="{% trans 'Search...' %}"
      value="{{ q }}"
    >
  </div>

  <div class="col-12 col-md-3">
    <select class="form-select" name="category" id="category-select">
      <option value="">{% trans "All Categories" %}</option>
      {% for c in categories %}
        {% with cid=c.id|stringformat:"s" %}
          <option value="{{ c.id }}" {% if category_id|stringformat:"s" == cid %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endwith %}
      {% endfor %}
    </select>
  </div>

  <div class="col-12 col-md-2">
    <select class="form-select" name="sort" id="sort-select">
      <option value="newest" {% if sort == "newest" %}selected{% endif %}>{% trans "Newest" %}</option>
      <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>{% trans "Price ↑" %}</option>
      <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>{% trans "Price ↓" %}</option>
    </select>
  </div>

  <div class="col-12 col-md-2 d-grid">
    <button class="btn btn-secondary" type="button" id="clear-filters">{% trans "Clear" %}</button>
  </div>
</form>

{# Grid ONLY #}
{% include "products/_product_grid.html" %}

{# ✅ Pagination container ثابت: يمنع duplication نهائياً #}
<div id="pagination-container">
  {% include "products/_pagination.html" %}
</div>

<script>
  // Set mine parameter from template
  const isMineFilter = "{{ mine|default:'' }}" === "1";

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById("filters-form");
    const categorySelect = document.getElementById("category-select");
    const sortSelect = document.getElementById("sort-select");
    const searchInput = document.getElementById("search-input");
    const clearBtn = document.getElementById("clear-filters");

    if (categorySelect) {
      categorySelect.addEventListener("change", function () {
        form.submit();
      });
    }

    if (sortSelect) {
      sortSelect.addEventListener("change", function () {
        form.submit();
      });
    }

    if (searchInput) {
      const performSearch = function () {
        const params = new URLSearchParams();
        const searchValue = searchInput.value.trim();

        if (searchValue) params.set('q', searchValue);
        if (categorySelect && categorySelect.value) params.set('category', categorySelect.value);
        if (sortSelect && sortSelect.value) params.set('sort', sortSelect.value);
        if (isMineFilter) params.set('mine', '1');


        fetch("{% url 'product_list_api' %}?" + params.toString(), {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
          // 1) Replace product grid
          const productGrid = document.getElementById('product-grid');
          if (productGrid && data.html) {
            productGrid.outerHTML = data.html;
          }

          // 2) Replace pagination safely (NO duplicates)
          const paginationContainer = document.getElementById('pagination-container');
          if (paginationContainer) {
            paginationContainer.innerHTML = data.pagination || '';
          }

          // 3) Update URL without reload
          const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
          window.history.pushState({}, '', newUrl);
        })
        .catch(error => console.error('Search error:', error));
      };

      if (typeof debounce === 'function') {
        const debouncedSearch = debounce(performSearch, 400);
        searchInput.addEventListener("input", debouncedSearch);
      } else {
        let searchTimeout;
        searchInput.addEventListener("input", function () {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(performSearch, 400);
        });
      }
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", function () {
        if (searchInput) searchInput.value = "";
        if (categorySelect) categorySelect.value = "";
        if (sortSelect) sortSelect.value = "newest";

        const url = new URL(window.location.href);
        url.searchParams.delete("q");
        url.searchParams.delete("category");
        url.searchParams.delete("sort");
        url.searchParams.delete("page");

        const mineParam = "{{ mine|default:'' }}";
        if (mineParam === "1") {
          url.searchParams.set("mine", "1");
        }

        window.location.href = url.toString();
      });
    }
  });

  // AJAX cart add functionality
  document.addEventListener('DOMContentLoaded', function () {
    const forms = document.querySelectorAll('.cart-add-form');

    forms.forEach(function (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const button = form.querySelector('button[type="submit"]');
        const messageSpan = form.querySelector('.cart-add-message');
        const originalText = button.textContent.trim();

        button.disabled = true;
        button.textContent = '{% trans "Adding..." %}';
        messageSpan.textContent = '';
        messageSpan.className = 'cart-add-message';

        const formData = new FormData(form);
        const url = form.getAttribute('action');

        fetch(url, {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            button.textContent = '{% trans "Added" %}';
            button.classList.remove('btn-success');
            button.classList.add('btn-secondary');
            button.disabled = false;

            messageSpan.textContent = data.message;
            messageSpan.className = 'cart-add-message text-success';

            updateCartCount(data.cart_count);
          } else {
            button.textContent = originalText;
            messageSpan.textContent = data.message;
            messageSpan.className = 'cart-add-message text-danger';
            button.disabled = false;
          }
        })
        .catch(error => {
          console.error('Error:', error);
          button.textContent = originalText;
          button.disabled = false;
          messageSpan.textContent = '{% trans "An error occurred. Please try again." %}';
          messageSpan.className = 'cart-add-message text-danger';
        });
      });
    });

    function updateCartCount(count) {
      const cartLink = document.querySelector('.cart-icon-link');
      if (!cartLink) return;

      let cartBadge = cartLink.querySelector('.badge.bg-danger');

      if (count > 0) {
        if (cartBadge) {
          cartBadge.textContent = count;
          cartBadge.style.display = '';
        } else {
          cartBadge = document.createElement('span');
          cartBadge.className = 'position-absolute top-0 start-50 translate-middle badge rounded-circle bg-danger';
          cartBadge.style.cssText = 'font-size: 0.7em; min-width: 1.2em; height: 1.2em; padding: 0.15em 0.3em; line-height: 1;';
          cartBadge.textContent = count;
          cartLink.appendChild(cartBadge);
        }
      } else {
        if (cartBadge) cartBadge.style.display = 'none';
      }
    }
  });
</script>
{% endblock %}
