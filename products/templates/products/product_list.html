{% extends "base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="m-0">Products</h1>
  {% if perms.products.add_product %}
    <a class="btn btn-primary" href="{% url 'product_create' %}">+ Add Product</a>
  {% endif %}
</div>

{% if mine == "1" %}
<div class="alert alert-info">
  <strong>My Products:</strong> Showing only products you own. <a href="{% url 'product_list' %}" class="alert-link">View all products</a>
</div>
{% endif %}

<form id="filters-form" method="get" class="row g-2 mb-4">
  {% if mine == "1" %}
  <input type="hidden" name="mine" value="1">
  {% endif %}
  <div class="col-md-5">
    <input class="form-control" type="text" name="q" placeholder="Search..." value="{{ q }}">
  </div>

  <div class="col-md-3">
    <select class="form-select" name="category">
      <option value="">All Categories</option>
      {% for c in categories %}
        <option value="{{ c.id }}" {% if category_id|stringformat:"s" == c.id|stringformat:"s" %}selected{% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <select class="form-select" name="sort">
      <option value="newest" {% if sort == "newest" %}selected{% endif %}>Newest</option>
      <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>Price ↑</option>
      <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Price ↓</option>
    </select>
  </div>

  <div class="col-md-2 d-grid">
    <div class="d-flex gap-2">
      <button class="btn btn-dark flex-fill" type="submit">Apply</button>
      <button class="btn btn-secondary flex-fill" type="button" id="clear-filters">Clear</button>
    </div>
  </div>
</form>

{% include "products/_product_grid.html" %}
{% include "products/_pagination.html" %}

<script>
(function() {
  const form = document.querySelector("#filters-form") || document.querySelector("form");
  const gridContainer = document.querySelector("#product-grid").parentElement;
  const paginationContainer = document.querySelector(".pagination")?.parentElement || gridContainer;

  function fetchProducts(page = null) {
    const params = new URLSearchParams(new FormData(form));
    if (page) params.set("page", page);
    {% if mine == "1" %}
    params.set("mine", "1");
    {% endif %}
    fetch("{% url 'product_list_api' %}?" + params.toString(), {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(r => r.json())
    .then(data => {
      gridContainer.innerHTML = data.html;
      paginationContainer.innerHTML = data.pagination;
      wirePagination();
    });
  }

  function wirePagination() {
    document.querySelectorAll("[data-page]").forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        fetchProducts(e.target.getAttribute("data-page"));
      });
    });
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    fetchProducts();
  });

  const clearBtn = document.querySelector("#clear-filters");
  if (clearBtn) {
    clearBtn.addEventListener("click", () => {
      form.reset();
      fetchProducts();
    });
  }

  wirePagination();
})();
</script>
{% endblock %}