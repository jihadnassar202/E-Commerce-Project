{% extends "base.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<div
  class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4 gap-2">
  <h1 class="m-0">Products</h1>
  {% if perms.products.add_product %}
  <a class="btn btn-primary" href="{% url 'product_create' %}">+ Add Product</a>
  {% endif %}
</div>

{% if mine == "1" %}
<div class="alert alert-info">
  <strong>My Products:</strong> Showing only products you own. <a href="{% url 'product_list' %}"
    class="alert-link">View all products</a>
</div>
{% endif %}

<form id="filters-form" method="get" class="row g-2 mb-4">
  {% if mine == "1" %}
  <input type="hidden" name="mine" value="1">
  {% endif %}
  <div class="col-12 col-md-5">
    <input class="form-control" type="text" name="q" id="search-input" placeholder="Search..." value="{{ q }}">
  </div>

  <div class="col-12 col-md-3">
    <select class="form-select" name="category" id="category-select">
      <option value="">All Categories</option>
      {% for c in categories %}
        {% with cid=c.id|stringformat:"s" %}
          <option value="{{ c.id }}" {% if category_id|stringformat:"s" == cid %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endwith %}
      {% endfor %}
    </select>
  </div>

  <div class="col-12 col-md-2">
    <select class="form-select" name="sort" id="sort-select">
      <option value="newest" {% if sort == "newest" %}selected{% endif %}>Newest</option>
      <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>Price ↑</option>
      <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Price ↓</option>
    </select>
  </div>

  <div class="col-12 col-md-2 d-grid">
    <button class="btn btn-secondary" type="button" id="clear-filters">Clear</button>
  </div>
</form>

{% include "products/_product_grid.html" %}
{% include "products/_pagination.html" %}

<script>
  (function () {
    const form = document.getElementById("filters-form");
    const categorySelect = document.getElementById("category-select");
    const sortSelect = document.getElementById("sort-select");
    const searchInput = document.getElementById("search-input");
    const clearBtn = document.getElementById("clear-filters");

    if (categorySelect) {
      categorySelect.addEventListener("change", function () {
        form.submit();
      });
    }

    if (sortSelect) {
      sortSelect.addEventListener("change", function () {
        form.submit();
      });
    }

    if (searchInput) {
      searchInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          form.submit();
        }
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", function () {
        if (searchInput) searchInput.value = "";
        if (categorySelect) categorySelect.value = "";
        if (sortSelect) sortSelect.value = "newest";

        const url = new URL(window.location.href);
        url.searchParams.delete("q");
        url.searchParams.delete("category");
        url.searchParams.delete("sort");
        url.searchParams.delete("page");

        const mineParam = "{{ mine|default:'' }}";
        if (mineParam === "1") {
          url.searchParams.set("mine", "1");
        }

        window.location.href = url.toString();
      });
    }
  })();
</script>
{% endblock %}
