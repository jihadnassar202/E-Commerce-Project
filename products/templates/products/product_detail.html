{% extends "base.html" %}
{% load i18n %}
{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 col-md-8">
    <h1 class="mb-2">{{ product.name }}</h1>
    {% if product.image %}
    <img src="{{ product.image.url }}" class="img-fluid mb-3 w-100" alt="{{ product.name }}"
      style="max-height: 400px; object-fit: cover;">
    {% endif %}
    {% if product.stock == 0 %}
    <span class="badge bg-danger mb-2">{% trans "Sold Out" %}</span>
    {% endif %}

    <p class="text-muted mb-1">
      <strong>{% trans "Category:" %}</strong> {{ product.category.name }}
    </p>

    <p class="mb-1">
      <strong>{% trans "Price:" %}</strong> ${{ product.price }}
    </p>

    <p class="mb-1">
      <strong>{% trans "Stock:" %}</strong> {{ product.stock }}
    </p>

    <p class="mt-3">{{ product.description }}</p>

    {% if is_owner %}
    <div class="alert alert-info mt-3">
      <strong>{% trans "This is your product." %}</strong> {% trans "You cannot purchase your own products." %}
    </div>
    {% else %}
    <form method="post" action="{% url 'cart_add' product.id %}" class="mt-3 cart-add-form"
      data-product-id="{{ product.id }}" data-adding-text="{% trans 'Adding...' %}"
      data-added-text="{% trans 'Added!' %}" data-error-text="{% trans 'An error occurred. Please try again.' %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-success" {% if product.stock == 0 %}disabled{% endif %}>
        {% if product.stock == 0 %}{% trans "Sold out" %}{% else %}{% trans "Add to cart" %}{% endif %}
      </button>
      <span class="cart-add-message ms-2"></span>
    </form>
    {% endif %}

    <a href="{% url 'cart_detail' %}" class="btn btn-outline-secondary mt-2">
      {% trans "View cart" %}
    </a>

    {% if user.is_authenticated %}
    <div class="mt-3">
      {% if perms.products.change_product %}
      <a class="btn btn-sm btn-outline-primary" href="{% url 'product_update' product.pk %}">{% trans "Edit" %}</a>
      {% endif %}

      {% if perms.products.delete_product %}
      <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
        data-bs-target="#deleteModal">{% trans "Delete" %}</button>
      {% endif %}
    </div>
    {% endif %}

    <div class="mt-4">
      <a href="{% url 'product_list' %}">‚Üê {% trans "Back to products" %}</a>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
{% if perms.products.delete_product %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">{% trans "Delete Product" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <p>{% blocktrans %}Are you sure you want to delete <strong>{{ product.name }}</strong>?{% endblocktrans %}</p>
        <p class="text-danger">{% trans "This action cannot be undone." %}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
        <form method="post" action="{% url 'product_delete' product.pk %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">{% trans "Delete" %}</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('.cart-add-form');
    if (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const button = form.querySelector('button[type="submit"]');
        const messageSpan = form.querySelector('.cart-add-message');
        const originalText = button.textContent;

        // Disable button and show loading
        button.disabled = true;
        button.textContent = form.dataset.addingText || 'Adding...';
        messageSpan.textContent = '';
        messageSpan.className = 'cart-add-message ms-2';

        const formData = new FormData(form);
        const url = form.getAttribute('action');

        fetch(url, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              button.textContent = form.dataset.addedText || 'Added!';
              messageSpan.textContent = data.message;
              messageSpan.className = 'cart-add-message ms-2 text-success';

              // Update cart count in navbar
              updateCartCount(data.cart_count);

              // Reset button after 2 seconds
              setTimeout(() => {
                button.textContent = originalText;
                messageSpan.textContent = '';
                messageSpan.className = 'cart-add-message ms-2';
              }, 2000);
            } else {
              button.textContent = originalText;
              messageSpan.textContent = data.message;
              messageSpan.className = 'cart-add-message ms-2 text-danger';
            }
            button.disabled = false;
          })
          .catch(error => {
            console.error('Error:', error);
            button.textContent = originalText;
            button.disabled = false;
            messageSpan.textContent = form.dataset.errorText || 'An error occurred. Please try again.';
            messageSpan.className = 'cart-add-message ms-2 text-danger';
          });
      });
    }

    function updateCartCount(count) {
      const cartBadge = document.querySelector('.badge.bg-danger');
      const cartLink = document.querySelector('a[href*="cart"]');

      if (count > 0) {
        if (cartBadge) {
          cartBadge.textContent = count;
          cartBadge.style.display = '';
        } else if (cartLink) {
          // Create badge if it doesn't exist
          const badge = document.createElement('span');
          badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-circle bg-danger';
          badge.style.cssText = 'font-size: 0.7em; min-width: 1.2em; height: 1.2em; padding: 0.15em 0.3em; line-height: 1; margin-left: -0.5rem;';
          badge.textContent = count;
          cartLink.appendChild(badge);
        }
      } else {
        if (cartBadge) {
          cartBadge.style.display = 'none';
        }
      }
    }
  });
</script>
{% endblock %}