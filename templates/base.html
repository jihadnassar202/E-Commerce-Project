<!doctype html>
{% load i18n %}
{% load core_extras %}

{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}

<html lang="{{ LANGUAGE_CODE|default:'en' }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}{% trans "Ecommerce" %}{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Mobile-first responsive adjustments */
    @media (max-width: 768px) {
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }

      .navbar-brand {
        font-size: 1rem;
      }

      main.container {
        margin-top: 1rem !important;
        margin-bottom: 1rem !important;
      }

      h1 {
        font-size: 1.75rem;
      }

      h2 {
        font-size: 1.5rem;
      }

      h3 {
        font-size: 1.25rem;
      }

      h4 {
        font-size: 1.1rem;
      }

      .table-responsive {
        font-size: 0.9rem;
      }

      .btn-lg {
        font-size: 1rem;
        padding: 0.5rem 1rem;
      }
    }

    .navbar .nav-link {
      transition: opacity 0.3s ease;
    }

    .navbar .nav-link:hover {
      opacity: 0.8;
    }

    .navbar-brand:hover {
      opacity: 0.9;
    }

    .navbar .btn-outline-light {
      transition: background-color 0.3s ease, opacity 0.3s ease;
    }

    .navbar .btn-outline-light:hover {
      background-color: rgba(255, 255, 255, 0.1);
      opacity: 0.9;
    }

    .navbar .btn-light {
      transition: background-color 0.3s ease, opacity 0.3s ease;
    }

    .navbar .btn-light:hover {
      background-color: rgba(255, 255, 255, 0.8);
      opacity: 0.9;
    }

    /* Mobile navbar adjustments */
    @media (max-width: 991px) {
      .navbar-nav.d-flex.flex-row {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }

      .navbar-nav .nav-item {
        width: 100%;
      }

      .navbar-nav .btn {
        width: 100%;
      }
    }

    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    @media (hover: hover) {
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
      }

      .card:hover .card-img-top {
        transform: scale(1.05);
      }

      .card .btn-success:hover {
        background-color: #198754;
        transform: scale(1.05);
      }
    }

    .card-img-top {
      transition: transform 0.3s ease;
    }

    .card .btn-success {
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    /* Language switcher styling */
    .navbar .form-select {
      cursor: pointer;
    }

    .navbar .form-select option {
      color: black;
    }

    /* RTL Support */
    [dir="rtl"] .navbar-nav.d-flex.flex-row {
      flex-direction: row-reverse;
    }

    [dir="rtl"] .toast-container {
      left: 0;
      right: auto;
    }

    [dir="rtl"] .badge.position-absolute.top-0.start-100 {
      right: 100%;
      left: auto;
    }

    [dir="rtl"] .btn-close {
      margin-left: auto;
      margin-right: -0.5rem;
    }

    [dir="rtl"] .ms-2 {
      margin-left: 0 !important;
      margin-right: 0.5rem !important;
    }

    [dir="rtl"] .me-auto {
      margin-left: auto !important;
      margin-right: 0 !important;
    }

    /* Override for navbar nav items to keep them aligned with brand in RTL */
    [dir="rtl"] .navbar .navbar-nav.me-auto {
      margin-left: 0 !important;
      margin-right: 0 !important;
    }

    [dir="rtl"] .text-end {
      text-align: left !important;
    }

    [dir="rtl"] .text-start {
      text-align: right !important;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg" style="background-color: #2d5016;">
    <div class="container">
      <a class="navbar-brand text-white fw-bold" href="{% url 'home' %}">{% trans "E-Commerce" %}</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
        style="border-color: rgba(255,255,255,.5);">
        <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
      </button>

      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'home' %}">{% trans "Home" %}</a>
          </li>

          {% if user.is_authenticated and user|is_seller %}
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'product_list' %}?mine=1">{% trans "My Products" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'orders_list' %}">{% trans "Orders" %}</a>
          </li>
          {% endif %}

          {% if user.is_staff %}
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'manage_sellers' %}">{% trans "Manage Sellers" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'category_list' %}">{% trans "Categories" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/">{% trans "Admin" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'product_list_admin' %}">{% trans "Admin Products" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="{% url 'orders_list' %}">{% trans "Orders" %}</a>
          </li>
          {% endif %}
        </ul>

        <ul class="navbar-nav d-flex flex-row align-items-center" style="gap: 1rem;">
          <li class="nav-item">
            <form action="{% url 'set_language' %}" method="post" class="d-inline">
              {% csrf_token %}
              <input name="next" type="hidden" value="{{ request.get_full_path }}">
              <select name="language" onchange="this.form.submit()" class="form-select form-select-sm"
                style="width: auto; display: inline-block; background-color: transparent; color: white; border-color: rgba(255,255,255,.5);">
                {% get_current_language as LANGUAGE_CODE %}
                {% for lang_code, lang_name in LANGUAGES %}
                <option value="{{ lang_code }}" {% if lang_code == LANGUAGE_CODE %}selected{% endif %}
                  style="color: black;">
                  {{ lang_name }}
                </option>
                {% endfor %}
              </select>
            </form>
          </li>

          <li class="nav-item">
            <a class="nav-link text-white position-relative d-inline-flex flex-column align-items-center cart-icon-link" href="{% url 'cart_detail' %}"
              style="padding: 0.5rem; text-decoration: none;">
              {% if cart_count > 0 %}
              <span class="position-absolute top-0 start-50 translate-middle badge rounded-circle bg-danger"
                style="font-size: 0.7em; min-width: 1.2em; height: 1.2em; padding: 0.15em 0.3em; line-height: 1;">
                {{ cart_count }}
              </span>
              {% endif %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" style="color: white;">
                <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 14a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm2 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm2 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm2 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
              </svg>
            </a>
          </li>

          {% if user.is_authenticated %}
          <li class="nav-item">
            <span class="navbar-text text-white" style="padding-left: 0.5rem;">
              {% blocktrans with username=user.username %}Hi {{ username }}{% endblocktrans %}
            </span>
          </li>

          <li class="nav-item">
            <form method="post" action="{% url 'logout' %}" class="d-inline m-0">
              {% csrf_token %}
              <button class="btn btn-outline-light btn-sm">{% trans "Logout" %}</button>
            </form>
          </li>
          {% else %}
          <li class="nav-item">
            <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">{% trans "Login" %}</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-light btn-sm" href="{% url 'signup' %}">{% trans "Register" %}</a>
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <main class="container mt-3 mt-md-4 mb-3 mb-md-4">
    {% block content %}{% endblock %}
  </main>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
    {% if messages %}
    {% for message in messages %}
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true"
      data-bs-delay="5000">
      <div
        class="toast-header {% if message.tags == 'error' or message.tags == 'danger' %}text-bg-danger{% elif message.tags == 'success' %}text-bg-success{% elif message.tags == 'warning' %}text-bg-warning{% else %}text-bg-info{% endif %}">
        <strong class="me-auto">
          {% if message.tags == 'error' or message.tags == 'danger' %}{% trans "Error" %}
          {% elif message.tags == 'success' %}{% trans "Success" %}
          {% elif message.tags == 'warning' %}{% trans "Warning" %}
          {% else %}{% trans "Info" %}{% endif %}
        </strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"
          aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="toast-body">
        {{ message }}
      </div>
    </div>
    {% endfor %}
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Global debouncer utility - single source of truth
    // Usage: const debouncedFunction = debounce(callback, delay);
    function debounce(func, delay) {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }

    const navbarForm = document.getElementById('navbar-search-form');
    if (navbarForm) {
      navbarForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(navbarForm);
        const params = new URLSearchParams(formData);
        window.location.href = "{% url 'product_list' %}?" + params.toString();
      });
    }

    // Initialize and show toast notifications
    document.addEventListener('DOMContentLoaded', function () {
      const toastElements = document.querySelectorAll('.toast');
      toastElements.forEach(function (toastElement) {
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
      });
    });
  </script>
</body>

</html>
