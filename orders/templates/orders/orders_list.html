{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Orders" %}{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4 gap-2">
  <h1 class="m-0">{% trans "Orders" %}</h1>
</div>

{% if is_seller_view %}
<div class="alert alert-info">
  <strong>{% trans "Seller View" %}:</strong> {% trans "Showing orders containing your products only." %}
</div>
{% endif %}

{% if page_obj %}
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>{% trans "Order ID" %}</th>
        <th>{% trans "Customer" %}</th>
        <th>{% trans "Items" %}</th>
        <th>{% trans "Status" %}</th>
        <th>{% trans "Total" %}</th>
        <th>{% trans "Date" %}</th>
        {% if is_seller_view %}<th>{% trans "Actions" %}</th>{% endif %}
      </tr>
    </thead>
    <tbody>
      {% for order in page_obj %}
      <tr>
        <td><strong>#{{ order.id }}</strong></td>
        <td>{{ order.user.username }}</td>
        <td>
          {% if is_seller_view %}
            {% for item in order.items.all %}
              {% if item.product.owner == user %}
                <div>{{ item.product.name }} x {{ item.quantity }} ({{ item.get_status_display }})</div>
              {% endif %}
            {% endfor %}
          {% else %}
            {% for item in order.items.all %}
              <div>{{ item.product.name }} x {{ item.quantity }}</div>
            {% endfor %}
          {% endif %}
        </td>
        <td>
          <span class="badge bg-{% if order.status == 'paid' %}success{% elif order.status == 'pending' %}warning{% else %}danger{% endif %}">
            {{ order.get_status_display }}
          </span>
        </td>
        <td>${{ order.total_amount }}</td>
        <td>{{ order.created_at|date:"M d, Y H:i" }}</td>
        {% if is_seller_view %}
        <td>
          <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#orderModal{{ order.id }}">
            {% trans "Manage Items" %}
          </button>
        </td>
        {% endif %}
      </tr>
      
      {% if is_seller_view %}
      <!-- Modal for order items management -->
      <div class="modal fade" id="orderModal{{ order.id }}" tabindex="-1" aria-labelledby="orderModalLabel{{ order.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="orderModalLabel{{ order.id }}">{% trans "Order #" %}{{ order.id }} - {% trans "Manage Items" %}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>{% trans "Product" %}</th>
                    <th>{% trans "Quantity" %}</th>
                    <th>{% trans "Price" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th>{% trans "Update Status" %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in order.items.all %}
                    {% if item.product.owner == user %}
                    <tr>
                      <td>{{ item.product.name }}</td>
                      <td>{{ item.quantity }}</td>
                      <td>${{ item.price_at_purchase }}</td>
                      <td>{{ item.get_status_display }}</td>
                      <td>
                        <form method="post" action="{% url 'order_item_update_status' item.id %}" class="d-inline">
                          {% csrf_token %}
                          <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="pending" {% if item.status == 'pending' %}selected{% endif %}>{% trans "Pending" %}</option>
                            <option value="processing" {% if item.status == 'processing' %}selected{% endif %}>{% trans "Processing" %}</option>
                            <option value="shipped" {% if item.status == 'shipped' %}selected{% endif %}>{% trans "Shipped" %}</option>
                            <option value="delivered" {% if item.status == 'delivered' %}selected{% endif %}>{% trans "Delivered" %}</option>
                            <option value="cancelled" {% if item.status == 'cancelled' %}selected{% endif %}>{% trans "Cancelled" %}</option>
                          </select>
                        </form>
                      </td>
                    </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
</div>

{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="Orders pagination">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.previous_page_number }}">{% trans "Previous" %}</a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">{% trans "Previous" %}</span></li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">
        {% blocktrans with page=page_obj.number total=page_obj.paginator.num_pages %}Page {{ page }} of {{ total }}{% endblocktrans %}
      </span>
    </li>

    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page_obj.next_page_number }}">{% trans "Next" %}</a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">{% trans "Next" %}</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% else %}
<p class="text-muted">{% trans "No orders found." %}</p>
{% endif %}
{% endblock %}

