{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "Cart" %}{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h2 class="fw-bold mb-4">{% trans "Your Cart" %}</h2>

    {% if items %}
    <div class="mb-4" id="cart-items">
      {% for it in items %}
      <div class="cart-item d-flex flex-column flex-md-row align-items-start align-items-md-center py-3 {% if not forloop.last %}border-bottom{% endif %} gap-3"
        data-product-id="{{ it.product.id }}" data-product-price="{{ it.product.price }}" data-max-quantity="{{ it.product.stock }}">
        <!-- Product Image and Info -->
        <div class="d-flex align-items-center flex-grow-1" style="min-width: 0;">
          <div class="me-3 flex-shrink-0">
            {% if it.product.image %}
            <img src="{{ it.product.image.url }}" alt="{{ it.product.name }}" class="img-fluid"
              style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
            {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center"
              style="width: 60px; height: 60px; border-radius: 8px;">
              <span class="text-muted" style="font-size: 0.7rem;">{% trans "No Image" %}</span>
            </div>
            {% endif %}
          </div>

          <!-- Product Info -->
          <div class="flex-grow-1" style="min-width: 0;">
            <div class="fw-bold mb-1 text-truncate">{{ it.product.name }}</div>
            <div class="text-muted">$<span class="item-price">{{ it.product.price }}</span></div>
          </div>
        </div>

        <!-- Quantity Controls and Remove -->
        <div class="d-flex align-items-center gap-2 flex-shrink-0">
          <!-- Quantity Controls -->
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm cart-decrement-btn"
              style="width: 35px; height: 35px;" data-product-id="{{ it.product.id }}">-</button>
            <span class="fw-bold item-quantity" style="min-width: 30px; text-align: center;">{{ it.quantity }}</span>
            <button type="button" class="btn btn-outline-secondary btn-sm cart-increment-btn" 
              style="width: 35px; height: 35px;" 
              data-product-id="{{ it.product.id }}"
              {% if it.quantity >= it.product.stock %}disabled{% endif %}>+</button>
          </div>

          <!-- Remove Button -->
          <button type="button" class="btn btn-danger btn-sm cart-remove-btn" 
            style="width: 35px; height: 35px;" 
            data-product-id="{{ it.product.id }}">Ã—</button>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Total and Checkout -->
    <div
      class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center pt-3 border-top gap-3">
      <h4 class="fw-bold m-0">{% trans "Total:" %} $<span id="cart-total">{{ total }}</span></h4>
      <form method="post" action="{% url 'checkout' %}" class="w-100 w-md-auto">
        {% csrf_token %}
        <button class="btn btn-success w-100 w-md-auto px-4">{% trans "Checkout" %}</button>
      </form>
    </div>
    {% else %}
    <div class="alert alert-info">{% trans "Cart is empty." %}</div>
    {% endif %}
  </div>
</div>

<!-- Bootstrap Modal for Delete Confirmation -->
<div class="modal fade" id="deleteCartItemModal" tabindex="-1" aria-labelledby="deleteCartItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteCartItemModalLabel">{% trans "Remove Item" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <p>{% trans "Are you sure you want to remove this item from your cart?" %}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">{% trans "Remove" %}</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get current language prefix from URL
  const currentPath = window.location.pathname;
  const langMatch = currentPath.match(/^\/([a-z]{2})\//);
  const langPrefix = langMatch ? `/${langMatch[1]}` : '';
  
  // Helper function to get CSRF token
  function getCSRFToken() {
    const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
    return tokenInput ? tokenInput.value : '';
  }
  
  // Helper function to update cart count in navbar
  function updateCartCount(count) {
    const cartLink = document.querySelector('.cart-icon-link');
    if (!cartLink) return;

    let cartBadge = cartLink.querySelector('.badge.bg-danger');

    if (count > 0) {
      if (cartBadge) {
        cartBadge.textContent = count;
        cartBadge.style.display = '';
      } else {
        // Create badge if it doesn't exist
        cartBadge = document.createElement('span');
        cartBadge.className = 'position-absolute top-0 start-50 translate-middle badge rounded-circle bg-danger';
        cartBadge.style.cssText = 'font-size: 0.7em; min-width: 1.2em; height: 1.2em; padding: 0.15em 0.3em; line-height: 1;';
        cartBadge.textContent = count;
        cartLink.appendChild(cartBadge);
      }
    } else {
      if (cartBadge) {
        cartBadge.style.display = 'none';
      }
    }
  }
  
  // Helper function to remove cart item from DOM
  function removeCartItem(productId) {
    const item = document.querySelector(`.cart-item[data-product-id="${productId}"]`);
    if (item) {
      item.style.transition = 'opacity 0.3s';
      item.style.opacity = '0';
      setTimeout(() => {
        item.remove();
        // Check if cart is empty
        const cartItems = document.getElementById('cart-items');
        if (cartItems && cartItems.children.length === 0) {
          location.reload(); // Reload to show empty cart message
        }
      }, 300);
    }
  }
  
  // Increment quantity
  document.querySelectorAll('.cart-increment-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const productId = this.getAttribute('data-product-id');
      const item = this.closest('.cart-item');
      const quantitySpan = item.querySelector('.item-quantity');
      const incrementBtn = item.querySelector('.cart-increment-btn');
      const decrementBtn = item.querySelector('.cart-decrement-btn');
      
      // Disable buttons during request
      incrementBtn.disabled = true;
      decrementBtn.disabled = true;
      
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', getCSRFToken());
      
      fetch(`${langPrefix}/cart/increment/${productId}/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          quantitySpan.textContent = data.quantity;
          document.getElementById('cart-total').textContent = data.cart_total;
          updateCartCount(data.cart_count);
          
          // Update increment button disabled state
          if (data.quantity >= data.max_quantity) {
            incrementBtn.disabled = true;
          } else {
            incrementBtn.disabled = false;
          }
        } else {
          alert(data.message);
        }
        decrementBtn.disabled = false;
      })
      .catch(error => {
        console.error('Error:', error);
        alert('{% trans "An error occurred. Please try again." %}');
        incrementBtn.disabled = false;
        decrementBtn.disabled = false;
      });
    });
  });
  
  // Decrement quantity
  document.querySelectorAll('.cart-decrement-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const productId = this.getAttribute('data-product-id');
      const item = this.closest('.cart-item');
      const quantitySpan = item.querySelector('.item-quantity');
      const incrementBtn = item.querySelector('.cart-increment-btn');
      const decrementBtn = item.querySelector('.cart-decrement-btn');
      
      // Disable buttons during request
      incrementBtn.disabled = true;
      decrementBtn.disabled = true;
      
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', getCSRFToken());
      
      fetch(`${langPrefix}/cart/decrement/${productId}/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (data.removed) {
            removeCartItem(productId);
            document.getElementById('cart-total').textContent = data.cart_total;
            updateCartCount(data.cart_count);
          } else {
            quantitySpan.textContent = data.quantity;
            document.getElementById('cart-total').textContent = data.cart_total;
            updateCartCount(data.cart_count);
            
            // Enable increment button
            incrementBtn.disabled = false;
            decrementBtn.disabled = false;
          }
        } else {
          alert(data.message);
          incrementBtn.disabled = false;
          decrementBtn.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('{% trans "An error occurred. Please try again." %}');
        incrementBtn.disabled = false;
        decrementBtn.disabled = false;
      });
    });
  });
  
  // Remove item with Bootstrap modal
  let pendingDeleteProductId = null;
  let pendingDeleteBtn = null;
  let pendingDeleteItem = null;
  
  const deleteModal = new bootstrap.Modal(document.getElementById('deleteCartItemModal'));
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  
  document.querySelectorAll('.cart-remove-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const productId = this.getAttribute('data-product-id');
      const item = this.closest('.cart-item');
      
      // Store the product ID and button for later use
      pendingDeleteProductId = productId;
      pendingDeleteBtn = this;
      pendingDeleteItem = item;
      
      // Show the modal
      deleteModal.show();
    });
  });
  
  // Handle confirmation in modal
  confirmDeleteBtn.addEventListener('click', function() {
    if (!pendingDeleteProductId) return;
    
    const productId = pendingDeleteProductId;
    const removeBtn = pendingDeleteBtn;
    
    // Hide the modal
    deleteModal.hide();
    
    // Disable the button during request
    removeBtn.disabled = true;
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    fetch(`${langPrefix}/cart/remove/${productId}/`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        removeCartItem(productId);
        document.getElementById('cart-total').textContent = data.cart_total;
        updateCartCount(data.cart_count);
      } else {
        alert(data.message);
        removeBtn.disabled = false;
      }
      // Reset pending delete variables
      pendingDeleteProductId = null;
      pendingDeleteBtn = null;
      pendingDeleteItem = null;
    })
    .catch(error => {
      console.error('Error:', error);
      alert('{% trans "An error occurred. Please try again." %}');
      removeBtn.disabled = false;
      // Reset pending delete variables
      pendingDeleteProductId = null;
      pendingDeleteBtn = null;
      pendingDeleteItem = null;
    });
  });
  
  // Reset pending delete when modal is closed without confirming
  document.getElementById('deleteCartItemModal').addEventListener('hidden.bs.modal', function() {
    if (pendingDeleteBtn) {
      pendingDeleteBtn.disabled = false;
    }
    pendingDeleteProductId = null;
    pendingDeleteBtn = null;
    pendingDeleteItem = null;
  });
});
</script>
{% endblock %}